package org.ton.kotlin.examples.faucet

import org.ton.api.pk.PrivateKeyEd25519
import org.ton.bigint.BigInt
import org.ton.block.Coins
import org.ton.block.MsgAddressInt
import org.ton.contract.wallet.WalletTransfer
import org.ton.kotlin.examples.contract.WalletV1R3Contract
import org.ton.kotlin.examples.provider.Provider
import org.ton.kotlin.message.MessageLayout

class TestnetFaucet(
    val provider: Provider
) {
    @OptIn(ExperimentalStdlibApi::class)
    private val SECRET =
        PrivateKeyEd25519("46aab91daaaa375d40588384fdf7e36c62d0c0f38c46adfea7f9c904c5973d97c02ece00eceb299066597ccc7a8ac0b2d08f0ad425f28c0ea92e74e2064f41f0".hexToByteArray())
    val wallet = WalletV1R3Contract(0, SECRET.publicKey(), provider)

    suspend fun topUpContract(destination: MsgAddressInt, amount: BigInt) =
        topUpContract(destination, Coins(amount))

    suspend fun topUpContract(destination: MsgAddressInt, amount: Long) =
        topUpContract(destination, Coins(amount))

    suspend fun topUpContract(destination: MsgAddressInt, amount: Coins) {
//        val account = provider.getAccountState(wallet.address)
//        val seqno = account?.let { wallet.getSeqno(it) } ?: 0
        val seqno = 0
//        println("faucet balance: ${account.balance}")
        println(destination.toAddrStd().toString(userFriendly = true))
        val message = WalletV1R3Contract.WalletV1R3Message(seqno, WalletTransfer {
            this.destination = destination
            this.coins = amount
            this.bounceable = false
//            this.messageData = MessageData.text("github.com/ton-community/ton-kotlin")
        }).sign(SECRET).toMessage(wallet.address, layout = MessageLayout.PLAIN)
        provider.sendMessage(WalletV1R3Contract.SignedWalletV1R3Message, message)
    }
}
// faucet:
// 1011010100101010000101101011101000110111001101010101000000011101111100011001100110010111010101010000111001111110110101001100010000010111010101001110111001010000000111011110110110001010100001000001000010001000110011100100001001111000101101100110110111100100         100100 000000

// norm
// 1000100000000001011010100101010000101101011101000110111001101010101000000011101111100011001100110010111010101010000111001111110110101001100010000010111010101001110111001010000000111011110110110001010100001000001000010001000110011100100001001111000101101100110110111100100 000000111011100001111111111010011011110101011010110100100011010111101110000101001100110100011111001001110000010000110010111100100010001111001111010001101110101010011111000010101100110110101011111111011010010100011111011010100001000001101110000011101110110011100001010001111110111010101010010000110101110011100001100100110001100001100111000111110101101001001001000010000111100000101111001111001100000100100011010111100110011101000101011110101000110001100101010100110000110111001001010001000111010110100000010010000001010000000000000000000000000000000000000011

// 1000100000000001011010100101010000101101011101000110111001101010101000000011101111100011001100110010111010101010000111001111110110101001100010000010111010101001110111001010000000111011110110110001010100001000001000010001000110011100100001001111000101101100110110111100100 000000001111010010110000011101100010011010100111101100100010000011100100110000101011011010011100110010010100101100100001001101000111111110111000101110100000110110001101101110101110011100101001110111000010110101011101000001100111000111001100010001011110011011011010010010100111110011111110111010010101110001010110011110010000100000001011000110100010010101010101001001000111101100011000110101111011100111110001010000010010110001001001110010110110111010000001000011110011101111010101110100110111100001000101001101000001110000000000000000000000000000000000000011